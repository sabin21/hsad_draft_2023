import WebGPUWeakMap from"./WebGPUWeakMap.js";import{lights}from"../../nodes/Nodes.js";function painterSortStable(e,r){return e.groupOrder!==r.groupOrder?e.groupOrder-r.groupOrder:e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.material.id!==r.material.id?e.material.id-r.material.id:e.z!==r.z?e.z-r.z:e.id-r.id}function reversePainterSortStable(e,r){return e.groupOrder!==r.groupOrder?e.groupOrder-r.groupOrder:e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id-r.id}class WebGPURenderList{constructor(){this.renderItems=[],this.renderItemsIndex=0,this.opaque=[],this.transparent=[],this.lightsNode=lights([]),this.lightsArray=[]}init(){return this.renderItemsIndex=0,this.opaque.length=0,this.transparent.length=0,this.lightsArray.length=0,this}getNextRenderItem(e,r,t,s,i,n){let d=this.renderItems[this.renderItemsIndex];return void 0===d?(d={id:e.id,object:e,geometry:r,material:t,groupOrder:s,renderOrder:e.renderOrder,z:i,group:n},this.renderItems[this.renderItemsIndex]=d):(d.id=e.id,d.object=e,d.geometry=r,d.material=t,d.groupOrder=s,d.renderOrder=e.renderOrder,d.z=i,d.group=n),this.renderItemsIndex++,d}push(e,r,t,s,i,n){const d=this.getNextRenderItem(e,r,t,s,i,n);(!0===t.transparent?this.transparent:this.opaque).push(d)}unshift(e,r,t,s,i,n){const d=this.getNextRenderItem(e,r,t,s,i,n);(!0===t.transparent?this.transparent:this.opaque).unshift(d)}pushLight(e){this.lightsArray.push(e)}getLightsNode(){return this.lightsNode.fromLights(this.lightsArray)}sort(e,r){this.opaque.length>1&&this.opaque.sort(e||painterSortStable),this.transparent.length>1&&this.transparent.sort(r||reversePainterSortStable)}finish(){this.lightsNode.fromLights(this.lightsArray);for(let e=this.renderItemsIndex,r=this.renderItems.length;e<r;e++){const r=this.renderItems[e];if(null===r.id)break;r.id=null,r.object=null,r.geometry=null,r.material=null,r.program=null,r.group=null}}}class WebGPURenderLists{constructor(){this.lists=new WeakMap,this.lists=new WebGPUWeakMap}get(e,r){const t=this.lists,s=[e,r];let i=t.get(s);return void 0===i&&(i=new WebGPURenderList,t.set(s,i)),i}dispose(){this.lists=new WeakMap}}export default WebGPURenderLists;